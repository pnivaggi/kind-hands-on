# Calisti Deployment on Kind

## Task 0. Allow multi-cluster

It could be required to run the following to add capacity if you need to install multiple cluster:

```bash
sudo sysctl fs.inotify.max_user_watches=524288
sudo sysctl fs.inotify.max_user_instances=512
```

## Task 1. Install Kind cluster

Prepare cluster configuration file:

```bash
tee kind-config.yaml <<EOF                           
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
EOF
```

In this lab we install a Kind cluster with Kubernetes v1.23, run the following command to deploy the cluster:

```bash
kind create cluster --name demo --config kind-config.yaml --image="kindest/node:v1.23.10@sha256:f047448af6a656fae7bc909e2fab360c18c487ef3edc93f06d78cdfd864b2d12"
```

## Task 2. Install SMM CLI

To deploy Calisti SMM you need to download SMM CLI. Download the SMM CLI binary from <https://calisti.app/download>.

Then move the binary file in a folder included in your PATH:

```bash
tar -xvf smm_1.10.0_linux_amd64.tar
chmod +x ./smm
mv ./smm /usr/bin/smm 
```

## Task 3. Check SMM CLI is installed

```bash
smm --version
```

```console 
Service Mesh Manager CLI version 1.10.0 (1d17b3310) built on 2022-08-04T20:15:29Z
```

## Task 4. Activate SMM with registry password

You need to activate SMM with the registration key/password generated on Calisti Download center at: <https://calisti.app/download>

```bash
SMM_REGISTRY_PASSWORD=REDACTED smm activate \
--host=registry.eticloud.io \
--prefix=smm \
--user=REDACTED
```

You should have an output similar to:

```console
? Are you sure to use the following context? kind-demo (API Server: https://127.0.0.1:40343) Yes
✓ validate-kubeconfig ❯ checking cluster reachability...
✓ Configuring docker image access for Service Mesh Manager.
✓ If you want to change these settings later, please use the 'registry' and 'activate' commands
```

## Task 5. Install SMM on Cluster

We will install SMM with Dashboard WebUI, prepare the configuration file:

```bash
tee enable-dashboard-expose.yaml <<EOF
spec:
  smm:
    exposeDashboard:
      meshGateway:
        enabled: true
    auth:
      forceUnsecureCookies: true
      mode: anonymous
EOF
```

Install SMM on the cluster with the config file for the Dashboard:

```bash
smm --non-interactive install -a --additional-cp-settings ./enable-dashboard-expose.yaml --cluster-name kind-demo
```

Check the installation with:

```bash
smm istio cluster status
```

## Task 6. Install MetalLb loadbalancer

Since version 0.13.0, MetalLB is configured via CRs and the original way of configuring it via a ConfigMap based configuration is not working anymore. Run the following command to install MetalLb:

```bash
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.5/config/manifests/metallb-native.yaml
```

## Task 7. Setup MetalLb loadbalancer

We will setup MetalLb using layer2 protocol. We need to provide MetalLb a range of IP addresses it controls. We want this range to be on the docker kind network.

```bash
docker network inspect -f '{{.IPAM.Config}}' kind
```

You should have an output similar to:

```console
[{172.18.0.0/16  172.18.0.1 map[]} {fc00:f853:ccd:e793::/64   map[]}]
```

We notice the CIDR used by Docker is ```172.18.0.0/16``` so we can allocate to MetalLb the following range ```172.18.255.200-172.18.255.250```.

Let's create the config file with the following command:

```bash
tee metallb-l2.yaml <<EOF
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: default
  namespace: metallb-system
spec:
  addresses:
  - 172.18.255.200-172.18.255.250
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: default
  namespace: metallb-system
EOF
```

Then apply the configuration:

```bash
kubectl apply -f metallb-l2.yaml
```

## Task 8. Install Caddy

```bash
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
```

## Task 9. Configure Caddy reverse proxy

Prepare the configuration script:

```bash
tee proxy.sh <<EOF
#!/bin/bash

ingressip=$(kubectl get svc smm-ingressgateway-external -n smm-system -o jsonpath="{.status.loadBalancer.ingress[0].ip}")
caddy reverse-proxy --from :8083 --to ${ingressip}:80 & 
EOF
```

Check the ingressip variable is valid (should be the first IP address from Load balancer IPPool range) and not empty:

```bash
echo $ingressip
```

Then apply the Caddy configuration

```bash
./proxy.sh
```

We have now a proxy configured between port 8083 and port 80 on load balancer IP address. 

## Task 10. Check Calisti SMM Dashboard

You can open the browser at location.hostname:8083

Use the token generated by the following command:

```bash
smm login
```

## Task 11. Install the demo app

```bash
smm demoapp install
```
